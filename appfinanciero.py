# -*- coding: utf-8 -*-
"""AppFinanciero.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1jHTVGFmeRVzpFSpQwkzQsxgy8nkvdL2e
"""

# Proyecto: APP Financiero
# Desarrollado por: Alejandro Ca√±as, Emmanuel Garc√≠a, Maricielo G√≥mez
# Descripci√≥n: App que determina el perfil del inversor y analiza acciones con Python.

pip install streamlit yfinance

pip install streamlit-option-menu

# Importar librerias ----
import streamlit as st #Interfaz intercativo
import pandas as pd #Manejo de dataframes
import numpy as np #Soporte de c√°lculo matem√°ticos y matrices
import yfinance as yf #Datos financieros de Yahoo Finance
import matplotlib.pyplot as plt #Gr√°ficos y visualizaciones de datos
import datetime #Manejo de fechas
from streamlit_option_menu import option_menu

# Inicializar variable de sesi√≥n ---
if "perfil" not in st.session_state:
    st.session_state.perfil = None

# Crear men√∫ lateral
with st.sidebar:
    seleccion = option_menu(
        "APP Financiero",
        ["Inicio", "Perfil de inversor", "Simulaci√≥n de portafolio - Una acci√≥n", "Simulaci√≥n de portafolio - Dos o m√°s acciones", "Referencias"],
        icons=["house", "graph-up", "bar-chart", "gear"],
        menu_icon="cast",
        default_index=0,
        orientation="vertical",
    )

# Contenido din√°mico
if seleccion == "Inicio":
    st.title("üè† Bienvenido a nuestra APP")
    st.header("‚ú® Tu estilo, tu riesgo, tu inversi√≥n.")
    st.markdown("""
    Esta app te ayuda a identificar tu *perfil de inversor* y analizar el comportamiento de acciones reales.""")
    st.markdown("Elige tus preferencias y descubre c√≥mo se ajustan a los distintos tipos de portafolio.")
    st.markdown("*Desarrollado por: Alejandro Ca√±as, Emmanuel Garc√≠a, Maricielo G√≥mez*")

elif seleccion == "Perfil de inversor":

    # üß≠ CUESTIONARIO DE PERFIL
    st.title("üß© Cuestionario del inversor")
    st.header("üë§ Descubre tu perfil de inversor")
    st.markdown("Responde las siguientes preguntas para determinar tu tolerancia al riesgo, horizonte y conocimiento.")
    st.markdown("---")

    puntaje_total = 0

    # --- SECCI√ìN I: TOLERANCIA AL RIESGO ---
    st.subheader("I. Tolerancia al riesgo (Tu reacci√≥n a la volatilidad)")

    q1 = st.radio(
        "1. Si tus acciones cayeran un 20% en un mes, t√∫...",
        [
            "Vender√≠as todo para evitar m√°s p√©rdidas.",
            "Mantendr√≠as la posici√≥n esperando la recuperaci√≥n.",
            "Aumentar√≠as tu inversi√≥n aprovechando los precios bajos."
        ],
        index=None
    )
    if q1:
        puntaje_total += [1, 3, 5][["Vender√≠as" in q1, "Mantendr√≠as" in q1, "Aumentar√≠as" in q1].index(True)]

    q2 = st.radio(
        "2. ¬øQu√© priorizas al invertir?",
        [
            "Seguridad y estabilidad del capital.",
            "Equilibrio entre crecimiento y seguridad.",
            "Rendimiento alto, aceptando fluctuaciones fuertes."
        ],
        index=None
    )
    if q2:
        puntaje_total += [1, 3, 5][["Seguridad" in q2, "Equilibrio" in q2, "Rendimiento" in q2].index(True)]

    q3 = st.radio(
        "3. ¬øQu√© nivel de ca√≠da podr√≠as tolerar en un a√±o?",
        [
            "Hasta 5%. Prefiero estabilidad.",
            "Entre 10% y 20%. Entiendo que los mercados bajan.",
            "M√°s del 25%. Asumo riesgos para buscar mayores retornos."
        ],
        index=None
    )
    if q3:
        puntaje_total += [1, 3, 5][["5%" in q3, "10%" in q3, "25%" in q3].index(True)]

    st.markdown("---")

    # --- SECCI√ìN II: HORIZONTE DE INVERSI√ìN ---
    st.subheader("II. Horizonte de inversi√≥n (Plazo)")

    q4 = st.radio(
        "4. ¬øCon qu√© objetivo inviertes principalmente?",
        [
            "Necesidades o gastos en el corto plazo (1 a 3 a√±os).",
            "Ahorros para metas en el mediano plazo (3 a 7 a√±os).",
            "Construir patrimonio o jubilaci√≥n (m√°s de 7 a√±os)."
        ],
        index=None
    )
    if q4:
        puntaje_total += [1, 3, 5][["corto" in q4, "mediano" in q4, "largo" in q4 or "m√°s" in q4].index(True)]

    q5 = st.radio(
        "5. ¬øCu√°ndo esperas usar la mayor√≠a de tu capital invertido?",
        [
            "Antes de 2 a√±os.",
            "En 5 a 10 a√±os.",
            "En m√°s de 15 a√±os."
        ],
        index=None
    )
    if q5:
        puntaje_total += [1, 3, 5][["Antes" in q5, "5 a 10" in q5, "15" in q5].index(True)]

    st.markdown("---")

    # --- SECCI√ìN III: CONOCIMIENTO Y EXPERIENCIA ---
    st.subheader("III. Conocimiento y experiencia")

    q6 = st.radio(
        "6. ¬øQu√© tan familiarizado est√°s con indicadores como el Ratio de Sharpe o el modelo CAPM?",
        [
            "No los conozco.",
            "He escuchado de ellos y entiendo lo b√°sico.",
            "Los uso en mis an√°lisis o estudios financieros."
        ],
        index=None
    )
    if q6:
        puntaje_total += [1, 3, 5][["No los conozco" in q6, "b√°sico" in q6, "uso" in q6].index(True)]

    q7 = st.radio(
        "7. ¬øEn qu√© tipo de activos sueles invertir o analizar?",
        [
            "Solo cuentas de ahorro o fondos conservadores.",
            "Acciones y bonos. Conozco los riesgos del mercado.",
            "Acciones, derivados o criptomonedas. Manejo portafolios activos."
        ],
        index=None
    )
    if q7:
        puntaje_total += [1, 3, 5][["ahorro" in q7, "Acciones y bonos" in q7, "criptomonedas" in q7].index(True)]

    st.markdown("---")

    # --- RESULTADO ---
    preguntas_respondidas = all([q1, q2, q3, q4, q5, q6, q7])

    if st.button("Calcular mi perfil de inversi√≥n"):
        if preguntas_respondidas:
            st.subheader("üéØ Resultado de tu perfil de inversi√≥n en acciones")
            st.metric("Puntuaci√≥n Total", puntaje_total)

            if puntaje_total <= 15:
                perfil = "Conservador üõ°Ô∏è"
                st.success(f"Tu perfil es: **{perfil}**")
                st.write("Prefieres estabilidad. Te convienen acciones de empresas grandes y consolidadas (blue chips) y fondos indexados de bajo riesgo.")
                st.session_state.perfil = "CONSERVADOR"

            elif puntaje_total <= 25:
                perfil = "Moderado üåø"
                st.info(f"Tu perfil es: **{perfil}**")
                st.write("Buscas equilibrio. Puedes combinar acciones defensivas con sectores de crecimiento moderado.")
                st.session_state.perfil = "MODERADO"

            else:
                perfil = "Agresivo üî•"
                st.warning(f"Tu perfil es: **{perfil}**")
                st.write("Tienes alta tolerancia al riesgo. Podr√≠as enfocarte en acciones de alto crecimiento, emergentes o tecnolog√≠a, usando an√°lisis de Sharpe o CAPM.")
                st.session_state.perfil = "AGRESIVO"

        else:
            st.error("Por favor responde todas las preguntas antes de calcular tu perfil.")

elif seleccion == "Resultados":
    st.header("üìà Resultados del an√°lisis")

    if st.session_state.perfil is None:
        st.error("üõë Por favor, completa el **Cuestionario del Inversor** en la pesta√±a anterior para desbloquear la simulaci√≥n.")
    else:
        st.success(f"Perfil Actual: **{st.session_state.perfil}**. ¬°Configura tu simulaci√≥n!")

        st.subheader("Configuraci√≥n de Acciones")
        single_ticker = st.text_input(
            "Ingrese **un √∫nico Ticker** para an√°lisis individual (ej: AAPL, AMZN, GOOG, MSFT	)",
            value=""
        )

        today = datetime.date.today()
        three_years_ago = today - datetime.timedelta(days=3 * 365)

        st.header("Selector de rango de Fechas Hist√≥ricas")
        d = st.date_input(
            "Seleccione el per√≠odo hist√≥rico para el an√°lisis",
            value=(three_years_ago, today),
            min_value=datetime.date(1990, 1, 1),
            max_value=today,
            format="MM.DD.YYYY",
        )
        st.write("El rango seleccionado es:", d)

        # Define num_activos based on whether a single ticker is entered
        num_activos = 1 if single_ticker else 0

        if st.button("Analicemos esta acci√≥n!"):
            # Code to analyze the single ticker goes here
            # For now, I'll just add a placeholder
            st.write("Analizando:", single_ticker)


        # Mostrar el bot√≥n de simulaci√≥n solo si hay tickers ingresados
        if num_activos > 0:
            if st.button("Ejecutar Simulaci√≥n de Portafolio"):

                # Define get_data function
                def get_data(tickers, start_date, end_date, benchmark_ticker="^GSPC"):
                    """Downloads historical data for tickers and a benchmark."""
                    data = yf.download(tickers, start=start_date, end=end_date)['Close']
                    benchmark_data = yf.download(benchmark_ticker, start=start_date, end=end_date)['Close']
                    return data, benchmark_data

                # Define calculate_beta function
                def calculate_beta(asset_returns, benchmark_returns):
                    """Calculates beta for each asset against the benchmark."""
                    betas = {}
                    for column in asset_returns.columns:
                        # Calculate covariance between asset and benchmark returns
                        covariance = asset_returns[column].cov(benchmark_returns.iloc[:, 0])
                        # Calculate variance of benchmark returns
                        benchmark_variance = benchmark_returns.iloc[:, 0].var()
                        # Calculate beta
                        beta = covariance / benchmark_variance
                        betas[column] = beta
                    return betas

                # Define MARKET_TICKER and RF
                MARKET_TICKER = "^GSPC" # S&P 500 as benchmark
                RF = 0.04 # Risk-Free Rate (example: 4%)


                # Descarga de datos
                try:
                    tickers = [single_ticker] # Use the single_ticker for analysis
                    start_date = d[0]
                    end_date = d[1]

                    datos, benchmark_data = get_data(tickers, start_date, end_date)

                    if datos.empty:
                        st.error("No se pudieron descargar los datos. Revise los s√≠mbolos de los tickers o el rango de fechas.")
                    else:
                        # C√ÅLCULOS B√ÅSICOS
                        retornos = datos.pct_change().dropna()
                        benchmark_retornos = benchmark_data.pct_change().dropna()

                        # Asegurar alineaci√≥n de retornos
                        retornos = pd.merge(retornos, benchmark_retornos, left_index=True, right_index=True, how='inner').drop(columns=[MARKET_TICKER])
                        benchmark_retornos = benchmark_retornos.loc[retornos.index]

                        retorno_anual = retornos.mean() * 252
                        volatilidad_anual = retornos.std() * np.sqrt(252)

                        # --- C√ÅLCULO CAPM ---
                        betas = calculate_beta(retornos, benchmark_retornos)
                        # Retorno del Mercado (Rm) anualizado
                        Rm = benchmark_retornos.mean().iloc[0] * 252

                        # Calcular Retorno Esperado por CAPM: E[Ri] = Rf + Beta * (Rm - Rf)
                        retorno_capm = {}
                        for t, beta in betas.items():
                            retorno_capm[t] = RF + beta * (Rm - RF)
                        retorno_capm_series = pd.Series(retorno_capm)

                        # Mostrar tabla de m√©tricas individuales
                        st.subheader("1. M√©tricas Individuales de Activos")

                        # C√°lculo del Ratio de Sharpe individual para la tabla
                        sharpe_anual = (retorno_anual - RF) / volatilidad_anual

                        metricas_df = pd.DataFrame({
                            'Retorno Anual Esperado (Hist√≥rico)': retorno_anual.apply(lambda x: f"{x*100:.2f}%"),
                            'Retorno Esperado (CAPM)': retorno_capm_series.apply(lambda x: f"{x*100:.2f}%"),
                            'Volatilidad Anual (Riesgo)': volatilidad_anual.apply(lambda x: f"{x*100:.2f}%"),
                            'Beta (vs. S&P 500)': pd.Series(betas).round(2),
                            'Ratio de Sharpe': sharpe_anual.round(2)
                        })

                        # Reindexar la tabla para asegurar que el orden de los Tickers sea el mismo
                        metricas_df = metricas_df.reindex(columns=['Retorno Anual Esperado (Hist√≥rico)', 'Retorno Esperado (CAPM)', 'Volatilidad Anual (Riesgo)', 'Beta (vs. S&P 500)', 'Ratio de Sharpe'])

                        st.dataframe(metricas_df)


                        st.subheader(f"2. An√°lisis del Portafolio (Basado en Perfil {st.session_state.perfil})")

                        if num_activos == 1:
                            # --- C√ÅLCULO PARA 1 ACCI√ìN ---
                            st.markdown("‚ö†Ô∏è **Solo se ingres√≥ 1 activo:** El 'portafolio' es la acci√≥n individual. No hay beneficios de diversificaci√≥n.")

                            retorno_p = retorno_anual.iloc[0]
                            volatilidad_p = volatilidad_anual.iloc[0]
                            sharpe_p = sharpe_anual.iloc[0]

                            col_ret, col_vol, col_sharpe = st.columns(3)

                            with col_ret:
                                st.metric("Retorno Esperado", f"{retorno_p*100:.2f}%")
                            with col_vol:
                                st.metric("Volatilidad (Riesgo)", f"{volatilidad_p*100:.2f}%")
                            with col_sharpe:
                                st.metric("Ratio de Sharpe", f"{sharpe_p:.2f}")

                            # Gr√°fico de precios hist√≥ricos para el an√°lisis individual
                            st.markdown("#### Evoluci√≥n Hist√≥rica de Precios")
                            # Para evitar el error de Streamlit si la descarga de datos devuelve una Serie,
                            # nos aseguramos de que sea un DataFrame con el nombre de columna.
                            if isinstance(datos, pd.Series):
                                datos = datos.to_frame(name=single_ticker)
                            st.line_chart(datos)


                except Exception as e:
                    st.error(f"Error during simulation: {e}")

elif seleccion == "Configuraci√≥n":
    st.header("‚öôÔ∏è Configuraci√≥n de usuario")